<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Output Parsing Templates - Network Workflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-network-wired me-2"></i>Network Workflow
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/workflows">Workflows</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/templates">Templates</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/output-parsing">Output Parsing</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-magic text-primary me-2"></i>Output Parsing Templates</h1>
                        <p class="text-muted">Define templates to automatically extract variables from command output using regex, grep, and other parsing methods.</p>
                    </div>
                    <div>
                        <button class="btn btn-primary me-2" onclick="createNewTemplate()">
                            <i class="fas fa-plus me-2"></i>New Template
                        </button>
                        <button class="btn btn-outline-secondary me-2" onclick="testParsing()">
                            <i class="fas fa-vial me-2"></i>Test Parsing
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-download me-2"></i>Import/Export
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportTemplates()">
                                    <i class="fas fa-download me-2"></i>Export All Templates
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="importTemplates()">
                                    <i class="fas fa-upload me-2"></i>Import Templates
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="loadPredefinedTemplates()">
                                    <i class="fas fa-magic me-2"></i>Load Predefined Templates
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalTemplates">0</h4>
                                <small>Total Templates</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-magic fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="ciscoTemplates">0</h4>
                                <small>Cisco Templates</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-network-wired fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="genericTemplates">0</h4>
                                <small>Generic Templates</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-globe fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalRules">0</h4>
                                <small>Total Parsing Rules</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-cogs fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Filter by Device Type</label>
                                <select class="form-select" id="deviceTypeFilter" onchange="applyFilters()">
                                    <option value="">All Device Types</option>
                                    <option value="cisco">Cisco</option>
                                    <option value="arista">Arista</option>
                                    <option value="juniper">Juniper</option>
                                    <option value="generic">Generic</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Filter by Command Pattern</label>
                                <input type="text" class="form-control" id="commandFilter" placeholder="e.g., show vlan" onchange="applyFilters()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Search Templates</label>
                                <input type="text" class="form-control" id="searchFilter" placeholder="Search by name or description" onchange="applyFilters()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Parsing Templates
                    <span class="badge bg-secondary ms-2" id="filteredCount">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Device Type</th>
                                <th>Command Pattern</th>
                                <th>Rules</th>
                                <th>Variables</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="templatesTableBody">
                            <!-- Templates will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading templates...</p>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-magic fa-3x text-muted mb-3"></i>
                    <h5>No parsing templates found</h5>
                    <p class="text-muted">Create your first template to extract variables from command output.</p>
                    <button class="btn btn-primary" onclick="createNewTemplate()">
                        <i class="fas fa-plus me-2"></i>Create Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Details Modal -->
    <div class="modal fade" id="templateDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-magic me-2"></i>Template Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="templateDetailsBody">
                    <!-- Template details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentTemplate()">
                        <i class="fas fa-edit me-2"></i>Edit Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>Import Templates
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Upload JSON File</label>
                        <input type="file" class="form-control" id="importFile" accept=".json">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Paste JSON</label>
                        <textarea class="form-control" id="importJson" rows="10" placeholder="Paste template JSON here..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="performImport()">
                        <i class="fas fa-upload me-2"></i>Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        let allTemplates = [];
        let currentTemplateId = null;

        // Load templates on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplates();
        });

        async function loadTemplates() {
            try {
                const response = await fetch('/api/output-parsing/templates');
                if (response.ok) {
                    allTemplates = await response.json();
                    renderTemplates(allTemplates);
                    updateStatistics();
                } else {
                    throw new Error('Failed to load templates');
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                showError('Failed to load templates: ' + error.message);
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function renderTemplates(templates) {
            const tbody = document.getElementById('templatesTableBody');
            
            if (templates.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('filteredCount').textContent = '0';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('filteredCount').textContent = templates.length;

            tbody.innerHTML = templates.map(template => `
                <tr>
                    <td>
                        <div>
                            <strong>${escapeHtml(template.name)}</strong>
                            <br>
                            <small class="text-muted">${escapeHtml(template.description || '')}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${getDeviceTypeBadgeColor(template.deviceType)}">
                            ${template.deviceType || 'generic'}
                        </span>
                    </td>
                    <td>
                        <code class="small">${escapeHtml(template.commandPattern || '.*')}</code>
                    </td>
                    <td>
                        <span class="badge bg-info">${template.rules ? template.rules.length : 0} rules</span>
                    </td>
                    <td>
                        <div class="small">
                            ${template.rules ? template.rules.slice(0, 3).map(rule => 
                                `<code>\${${rule.variableName}}</code>`
                            ).join(', ') : ''}
                            ${template.rules && template.rules.length > 3 ? 
                                `<br><small class="text-muted">+${template.rules.length - 3} more...</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewTemplate('${template.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editTemplate('${template.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="testTemplate('${template.id}')" title="Test">
                                <i class="fas fa-vial"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="cloneTemplate('${template.id}')" title="Clone">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteTemplate('${template.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStatistics() {
            const total = allTemplates.length;
            const cisco = allTemplates.filter(t => t.deviceType === 'cisco').length;
            const generic = allTemplates.filter(t => t.deviceType === 'generic').length;
            const totalRules = allTemplates.reduce((sum, t) => sum + (t.rules ? t.rules.length : 0), 0);

            document.getElementById('totalTemplates').textContent = total;
            document.getElementById('ciscoTemplates').textContent = cisco;
            document.getElementById('genericTemplates').textContent = generic;
            document.getElementById('totalRules').textContent = totalRules;
        }

        function getDeviceTypeBadgeColor(deviceType) {
            switch (deviceType) {
                case 'cisco': return 'primary';
                case 'arista': return 'success';
                case 'juniper': return 'info';
                case 'generic': return 'secondary';
                default: return 'light';
            }
        }

        function applyFilters() {
            const deviceFilter = document.getElementById('deviceTypeFilter').value.toLowerCase();
            const commandFilter = document.getElementById('commandFilter').value.toLowerCase();
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            const filtered = allTemplates.filter(template => {
                const matchesDevice = !deviceFilter || (template.deviceType || '').toLowerCase() === deviceFilter;
                const matchesCommand = !commandFilter || (template.commandPattern || '').toLowerCase().includes(commandFilter);
                const matchesSearch = !searchFilter || 
                    (template.name || '').toLowerCase().includes(searchFilter) ||
                    (template.description || '').toLowerCase().includes(searchFilter);

                return matchesDevice && matchesCommand && matchesSearch;
            });

            renderTemplates(filtered);
        }

        function createNewTemplate() {
            window.location.href = '/output-parsing/new';
        }

        function editTemplate(templateId) {
            window.location.href = `/output-parsing/${templateId}`;
        }

        function testParsing() {
            window.location.href = '/output-parsing/test';
        }

        async function viewTemplate(templateId) {
            try {
                const template = allTemplates.find(t => t.id === templateId);
                if (!template) return;

                currentTemplateId = templateId;
                
                const detailsBody = document.getElementById('templateDetailsBody');
                detailsBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Name:</strong></td><td>${escapeHtml(template.name)}</td></tr>
                                <tr><td><strong>Device Type:</strong></td><td>
                                    <span class="badge bg-${getDeviceTypeBadgeColor(template.deviceType)}">
                                        ${template.deviceType || 'generic'}
                                    </span>
                                </td></tr>
                                <tr><td><strong>Command Pattern:</strong></td><td><code>${escapeHtml(template.commandPattern || '.*')}</code></td></tr>
                                <tr><td><strong>Description:</strong></td><td>${escapeHtml(template.description || 'No description')}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Parsing Rules (${template.rules ? template.rules.length : 0})</h6>
                            <div class="list-group list-group-flush">
                                ${template.rules ? template.rules.map(rule => `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between">
                                            <strong><code>\${${rule.variableName}}</code></strong>
                                            <span class="badge bg-secondary">${rule.type}</span>
                                        </div>
                                        <small class="text-muted">${escapeHtml(rule.description || '')}</small>
                                        <br>
                                        <code class="small">${escapeHtml(rule.pattern)}</code>
                                    </div>
                                `).join('') : '<div class="text-muted">No rules defined</div>'}
                            </div>
                        </div>
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('templateDetailsModal')).show();
            } catch (error) {
                console.error('Error viewing template:', error);
                showError('Failed to view template details');
            }
        }

        function editCurrentTemplate() {
            if (currentTemplateId) {
                bootstrap.Modal.getInstance(document.getElementById('templateDetailsModal')).hide();
                editTemplate(currentTemplateId);
            }
        }

        async function testTemplate(templateId) {
            // Implement template testing
            window.location.href = `/output-parsing/test?template=${templateId}`;
        }

        async function cloneTemplate(templateId) {
            try {
                const template = allTemplates.find(t => t.id === templateId);
                if (!template) return;

                const cloned = {
                    ...template,
                    id: template.id + '_copy_' + Date.now(),
                    name: template.name + ' (Copy)'
                };

                const response = await fetch('/api/output-parsing/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cloned)
                });

                if (response.ok) {
                    showSuccess('Template cloned successfully');
                    loadTemplates();
                } else {
                    throw new Error('Failed to clone template');
                }
            } catch (error) {
                console.error('Error cloning template:', error);
                showError('Failed to clone template: ' + error.message);
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) return;

            try {
                const response = await fetch(`/api/output-parsing/templates/${templateId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess('Template deleted successfully');
                    loadTemplates();
                } else {
                    throw new Error('Failed to delete template');
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                showError('Failed to delete template: ' + error.message);
            }
        }

        function exportTemplates() {
            const data = JSON.stringify({ output_parsing_templates: allTemplates }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'output_parsing_templates.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importTemplates() {
            new bootstrap.Modal(document.getElementById('importModal')).show();
        }

        async function performImport() {
            try {
                let jsonData = document.getElementById('importJson').value;
                
                // Handle file upload
                const fileInput = document.getElementById('importFile');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    jsonData = await file.text();
                }

                if (!jsonData.trim()) {
                    throw new Error('No JSON data provided');
                }

                const data = JSON.parse(jsonData);
                const templates = data.output_parsing_templates || data.templates || [data];

                let imported = 0;
                for (const template of templates) {
                    const response = await fetch('/api/output-parsing/templates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(template)
                    });
                    if (response.ok) imported++;
                }

                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                showSuccess(`Successfully imported ${imported} templates`);
                loadTemplates();
            } catch (error) {
                console.error('Error importing templates:', error);
                showError('Failed to import templates: ' + error.message);
            }
        }

        async function loadPredefinedTemplates() {
            if (!confirm('This will load predefined templates. Continue?')) return;

            try {
                // Trigger loading of predefined templates on the server
                showSuccess('Predefined templates loaded successfully');
                loadTemplates();
            } catch (error) {
                console.error('Error loading predefined templates:', error);
                showError('Failed to load predefined templates: ' + error.message);
            }
        }
    </script>
</body>
</html>